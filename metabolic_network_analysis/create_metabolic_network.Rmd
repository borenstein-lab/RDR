---
title: "Create metabolic network"
output: html_notebook
---

This script reads PICRUSt data, combines it with compound data, and constructs a metabolic network.


```{r}

# 0 - Set up

picrust_data_path = "picrust_data_path" #picrust2 output, KO to ASV table
path_save_to = "path_save_to" # path to save files
asv_to_taxonomy = "asv_to_taxonomy" # file that map asv to taxonomy 
ko_compound_path <- "ko_compound_path" # file that map between KO and compounds - could be created using map_ko_to_compound.R


################################

### 1  - import data ###
# the data is relatively large and not needed outside the function

picrust_data <- read_delim(picrust_data_path, delim = "\t", escape_double = FALSE,trim_ws = TRUE)%>%
  rename(asv = sequence)%>%
  pivot_longer(-asv, names_to = "KO", values_to = "value")%>%
  filter(value != 0)%>% #for the network we don't care about copy number
  select(-value) 

# Run meanualy for rds data
# picrust_data <- read_rds(picrust_data_path)%>%
#   rename(KO = ko_id)

ko_compound <- read_rds(ko_compound_path)

### 2 - for each taxon take one representative ASV for network construction ###

representative_asv_to_taxon <- asv_to_taxonomy%>%
  group_by(taxon)%>%
  mutate(taxon = make.unique(taxon, sep = "_duplicate_"))%>%
  ungroup()%>%
  filter(!str_detect(taxon, "_duplicate_"))

picrust_data_filtered <- picrust_data%>%
  filter(asv %in% representative_asv_to_taxon$asv)

### 3 - combine with compound data ###

picrust_ko_to_compound <- left_join(picrust_data_filtered, ko_compound, by = "KO")%>%
  select(asv, Consuming, Producing)%>%
  unique()%>%
  drop_na() # remove KO's that are not maped to reactions

### 4  - give unique ID for every taxon ###
# windows is limited to file path in length of 260 bits so we give id to every taxon/asv  

picrust_ko_to_compound <- picrust_ko_to_compound%>%
  group_by(asv)%>%
  mutate(file_id = str_c("id_", cur_group_id()))%>%
  ungroup()

file_id_map <- picrust_ko_to_compound%>%
  select(asv, file_id)%>%
  unique()%>%
  left_join(asv_to_taxonomy)

### 5 - write metabolic network files ###  
picrust_ko_to_compound_file_path <- str_c(path_save_to, "/", unique(picrust_ko_to_compound$file_id), ".tab")
picrust_ko_to_compound_id_path <- str_c(path_save_to, "/", "id_map", ".txt")

picrust_ko_to_compound_list <- picrust_ko_to_compound%>%
  select(-asv)%>%
  group_by(file_id)%>%
  group_split(.keep = FALSE)

walk2(.x = picrust_ko_to_compound_file_path, 
      .y = picrust_ko_to_compound_list, 
      .f = ~write_tsv(col_names = FALSE, x = .y, file = .x))

# Write the ASV to file ID mapping
write_delim(file = picrust_ko_to_compound_id_path, x = file_id_map)

```

